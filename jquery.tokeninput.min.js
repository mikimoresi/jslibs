var tokenInputPageX,tokenInputPageY;jQuery(window).mousemove(function(c){tokenInputPageX=c.pageX;tokenInputPageY=c.pageY});
(function(c){var T={method:"GET",contentType:"json",queryParam:"q",searchDelay:600,minChars:2,propertyToSearch:"descrizione",jsonContainer:null,hintText:alertM.mansionariHintText,noResultsText:alertM.noResults,searchingText:alertM.searching,deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!0,idPrefix:"token-input-",inModal:!1,placeholder:!1,resultsFormatter:function(g){return"<li>"+g[this.propertyToSearch].replace("&apos;",
"'")+"</li>"},tokenFormatter:function(g){return"<li><p>"+g[this.propertyToSearch].replace("&apos;","'")+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},E={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",
inputToken:"token-input-input-token"},F={init:function(g,q){var a=c.extend({},T,q||{});return this.each(function(){c(this).data("tokenInputObject",new c.TokenList(this,g,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(g){this.data("tokenInputObject").add(g);return this},remove:function(g){this.data("tokenInputObject").remove(g);return this},get:function(){return this.data("tokenInputObject").getTokens()}};c.fn.tokenInput=function(g){return F[g]?F[g].apply(this,
Array.prototype.slice.call(arguments,1)):F.init.apply(this,arguments)};c.TokenList=function(g,q,a){function B(){null!==a.tokenLimit&&x>=a.tokenLimit&&(h.hide(),y())}function z(b){var e=a.tokenFormatter(b);e=c(e).addClass(a.classes.token).insertAfter(t);c("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(e).click(function(){G(c(this).parent());m.change();return!1});var d={id:b.id};d[a.propertyToSearch]=b[a.propertyToSearch];c.data(e.get(0),"tokeninput",b);u=u.slice(0,v).concat([d]).concat(u.slice(v));
v++;Q(u,m);x+=1;null!==a.tokenLimit&&x>=a.tokenLimit&&(h.hide(),y());return e}function C(b){var e=a.onAdd;if(0<x&&a.preventDuplicates){var d=null;A.children().each(function(){var f=c(this),l=c.data(f.get(0),"tokeninput");if(l&&l.id===b.id)return d=f,!1});if(d){H(d);t.insertAfter(d);h.focus();return}}if(null==a.tokenLimit||x<a.tokenLimit)z(b),B();h.val("");y();c.isFunction(e)&&e.call(m,b)}function H(b){b.addClass(a.classes.selectedToken);r=b.get(0);h.val("");y()}function I(b,e){b.removeClass(a.classes.selectedToken);
r=null;0===e?(t.insertBefore(b),v--):1===e?(t.insertAfter(b),v++):(t.appendTo(A),v=x);h.focus()}function G(b){var e=c.data(b.get(0),"tokeninput"),d=a.onDelete,f=u.length-b.prevAll().length;f>v&&f--;b.remove();r=null;u=u.slice(0,f).concat(u.slice(f+1));f<v&&v--;Q(u,m);--x;null!==a.tokenLimit&&h.show().val("").focus();c.isFunction(d)&&d.call(m,e)}function Q(b,e){var d=c.map(b,function(f){return f[a.tokenValue]});e.val(d.join(a.tokenDelimiter))}function y(b,e){var d=document.documentElement;if(b&&tokenInputPageX>
n[0].offsetLeft&&tokenInputPageX<n[0].offsetWidth+n[0].offsetLeft&&tokenInputPageY>n[0].offsetTop-d.scrollTop&&tokenInputPageY<n[0].offsetHeight+n[0].offsetTop+d.scrollTop&&!a.inFilter)return!1;n.hide().empty();w=null;a.placeholder&&""==h.val()&&a.placeholder.show()}function D(){if(a.inModal)var b=a.inModal.hasClassName("wideModal")?c(a.inModal.down("div.modal-content")).offset().top-12:c(a.inModal.down("div.modal-content")).offset().top-80,e=0;else a.inMovingHead?(b=c(a.inMovingHead).offset().top,
e=c(a.inMovingHead).offset().left):(b=a.inFilter?7:-4,e=0);a.placeholder&&a.placeholder.hide();n.css({position:"absolute",top:c(A).offset().top-b+34,left:c(A).offset().left-e,zindex:999}).show()}function J(b,e){if(e&&e.length){n.empty();var d=c("<ul>").appendTo(n).mouseover(function(f){K(c(f.target).closest("li"))}).mousedown(function(f){C(c(f.target).closest("li").data("tokeninput"));m.change();return!1}).hide();c.each(e,function(f,l){var k=a.resultsFormatter(l);if(b){var p=k.replace(/(<([^>]+)>)/ig,
"");var L=p.toLowerCase().indexOf(b.toLowerCase());if(-1<L)if(-1<b.indexOf("*"))k=p;else{var U=b.length;k=p.slice(0,L);p=p.slice(L+U);k="<li>"+k+"<b>"+(k.toUpperCase()==k&&k||p.toUpperCase()==p&&p?b.toUpperCase():b)+"</b>"+p+"</li>"}else k="<li>"+p+"</li>"}k=c(k).appendTo(d);f%2?k.addClass(a.classes.dropdownItem):k.addClass(a.classes.dropdownItem2);0===f&&K(k);c.data(k.get(0),"tokeninput",l)});D();a.animateDropdown&&!a.local_data?d.slideDown("fast"):d.show()}else a.noResultsText&&(n.html("<p>"+a.noResultsText+
"</p>"),D())}function K(b){b&&(w&&(c(w).removeClass(a.classes.selectedDropdownItem),w=null),b.addClass(a.classes.selectedDropdownItem),w=b.get(0))}function M(){var b=h.val();if(b&&b.length||a.local_data)r&&I(c(r),1),b.length>=a.minChars||a.local_data?(!a.local_data&&a.searchingText&&(n.html("<p>"+a.searchingText+"</p>"),D()),clearTimeout(R),R=setTimeout(function(){V(b)},a.searchDelay)):y()}function V(b){var e=b+N(),d=O.get(e);if(d)J(b,d);else if(a.url){d=N();var f={data:{}};-1<d.indexOf("?")?(d=d.split("?"),
f.url=d[0],d=d[1].split("&"),c.each(d,function(l,k){var p=k.split("=");f.data[p[0]]=p[1]})):f.url=d;f.data[a.queryParam]=b;f.type=a.method;f.dataType=a.contentType;f.sectoken=window.sectokenForAjax;a.crossDomain&&(f.dataType="jsonp");f.success=function(l){c.isFunction(a.onResult)&&(l=a.onResult.call(m,l));O.add(e,a.jsonContainer?l[a.jsonContainer]:l);h.val().toLowerCase()===b.toLowerCase()&&J(b,a.jsonContainer?l[a.jsonContainer]:l)};c.ajax(f)}else a.local_data&&(d=c.grep(a.local_data,function(l){return-1<
l[a.propertyToSearch].toLowerCase().indexOf(b.toLowerCase())}),c.isFunction(a.onResult)&&(d=a.onResult.call(m,d)),O.add(e,d),J(b,d))}function N(){var b=a.url;"function"==typeof a.url&&(b=a.url.call());return b}"string"===c.type(q)||"function"===c.type(q)?(a.url=q,q=N(),void 0===a.crossDomain&&(-1===q.indexOf("://")?a.crossDomain=!1:a.crossDomain=location.href.split(/\/+/g)[1]!==q.split(/\/+/g)[1])):"object"===typeof q&&(a.local_data=q);a.classes?a.classes=c.extend({},E,a.classes):a.theme?(a.classes=
{},c.each(E,function(b,e){a.classes[b]=e+"-"+a.theme})):a.classes=E;var u=[],x=0,O=new c.TokenList.Cache,R,P,h=c('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+g.name).focus(function(){a.placeholder&&a.placeholder.hide();a.local_data?M():null!==a.tokenLimit&&a.tokenLimit===x||!a.hintText||(n.html("<p>"+a.hintText+"</p>"),D())}).click(function(){a.local_data&&M()}).blur(function(b){c(this).val("");y(b,h)}).bind("keyup keydown blur update",function(){if(P!==(P=
h.val())){var b=P.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");S.html(b);h.width(S.width()+30)}}).keydown(function(b){switch(b.keyCode){case 37:case 39:case 38:case 40:if(c(this).val()||a.local_data){var e=null;e=40===b.keyCode||39===b.keyCode?c(w).next():c(w).prev();e.length&&K(e);return!1}e=t.prev();var d=t.next();e.length&&e.get(0)===r||d.length&&d.get(0)===r?37===b.keyCode||38===b.keyCode?I(c(r),0):I(c(r),1):37!==b.keyCode&&38!==b.keyCode||!e.length?39!==
b.keyCode&&40!==b.keyCode||!d.length||H(c(d.get(0))):H(c(e.get(0)));break;case 9:case 13:case 108:case 188:if(w)return C(c(w).data("tokeninput")),m.change(),!1;break;case 27:return y(),!0;default:String.fromCharCode(b.which)&&setTimeout(function(){M()},5)}}),m=c(g).hide().val("").focus(function(){h.focus()}).blur(function(){h.blur()}),r=null,v=0,w=null,A=c("<ul />").addClass(a.classes.tokenList).click(function(b){}).mouseover(function(b){(b=c(b.target).closest("li"))&&r!==this&&b.addClass(a.classes.highlightedToken)}).mouseout(function(b){(b=
c(b.target).closest("li"))&&r!==this&&b.removeClass(a.classes.highlightedToken)}).insertBefore(m),t=c("<li />").addClass(a.classes.inputToken).appendTo(A).append(h),n=a.inModal?c("<div>").addClass(a.classes.dropdown).appendTo(a.inModal).hide():a.inMovingHead?c("<div>").addClass(a.classes.dropdown).appendTo(a.inMovingHead).hide():c("<div>").addClass(a.classes.dropdown).appendTo("body").hide();1==a.tokenLimit&&(g=c(t).parents("div.form-group").children("label.control-label").html())&&(g=g.replace("*",
""))&&(g=g.replace(/<small.*>.*?<\/small>/ig,""),a.placeholder=g.replace(/<[^>]*>?/gm,""));a.placeholder&&(a.placeholder=c('<span class="placeholder">'+a.placeholder+"</span>").appendTo(t));1==a.tokenLimit&&t.addClass("noPlus");a.local_data&&(a.searchDelay=0);var S=c("<tester/>").insertAfter(h).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:h.css("fontSize"),fontFamily:h.css("fontFamily"),fontWeight:h.css("fontWeight"),letterSpacing:h.css("letterSpacing"),whiteSpace:"nowrap"});
m.val("");g=a.prePopulate||m.data("pre");a.processPrePopulate&&c.isFunction(a.onResult)&&(g=a.onResult.call(m,g));g&&g.length&&c.each(g,function(b,e){z(e);B()});c.isFunction(a.onReady)&&a.onReady.call();this.clear=function(){A.children("li").each(function(){0===c(this).children("input").length&&G(c(this))})};this.add=function(b){C(b)};this.remove=function(b){A.children("li").each(function(){if(0===c(this).children("input").length){var e=c(this).data("tokeninput"),d=!0,f;for(f in b)if(b[f]!==e[f]){d=
!1;break}d&&G(c(this))}})};this.getTokens=function(){return u}};c.TokenList.Cache=function(g){var q=c.extend({max_size:500},g),a={},B=0;this.add=function(z,C){B>q.max_size&&(a={},B=0);a[z]||(B+=1);a[z]=C};this.get=function(z){return a[z]}}})(jQuery);